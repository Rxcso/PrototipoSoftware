
@using WebApplication4.Models;
@{
    ViewBag.Title = "Comentarios";
    Layout = null;
    int offsetList = 0;

}

@{
    Comentario comm = Model;

}


<div class="row">
    <div class="thumbnail wrapper-container ">

        <div id="comment-container" class="container-fluid" padding="0 2%">

            <div class="row list-block-header">
                <h4><u>Comentarios</u></h4>
            </div>

            <div class="row row-list">

                <ol class="list-group list-block-comment">



                    <li class="list-group-item block-post">
                        <span data-title="one toogle" class=" glyphicon glyphicon-pencil set-opts-btn  my-popover"></span>


                        @{
                            AjaxOptions options = new AjaxOptions();
                            options.HttpMethod = "POST";
                            options.OnComplete = "RefreshWeb";





                        }



                        @using (Ajax.BeginForm("EnviarComentario", options))
                        {

                            /*
                            @Html.Hidden("evento_id", model.codigo);*/
                            @Html.Hidden("user_val", comm.usuario);
                            @Html.Hidden("codEvento", comm.codEvento);




                            <div class="form-group">
                                <div class="input-group form-post">
                                    <div id="warning_block" hidden class="alert-warning warning"></div>
                                    <textarea id="comm-cont-txt" name="comentario" rows="1" placeholder="Escribe un comentario de este evento"></textarea>
                                    <span class="input-group-btn pull-right"><input type="button" id="btn-post" onclick="postComment()" value="Post" class="btn btn-primary pull-right"></span>
                                    <!--<span class="input-group-btn pull-right"><a id="btn-search" onclick="postComment()" class="btn btn-primary pull-right">Post</a></span>
                                      -->
                                </div>
                            </div>

                        }


                    </li>





                </ol>

                <br />


            </div>

        </div>

    </div>

</div>
<script>


    $(document).ready(function () {




        var codEvento = @comm.codEvento;
        var usuario =$("#user_val").val();
        var contenido = $("#comm-cont-txt").val();


        $.call(cargarDatos('/Evento/GetComents', codEvento, usuario, contenido));

    });





        function reservaExitosa() {
            alert("Reserva exitosa, tiene hasta el final del día para pagarla");
        }




        $('.form-post').on('keyup', 'textarea', function () {
            $(this).height(0);
            $(this).height(this.scrollHeight);
        });
        $('.form-post').find('textarea').keyup();





        function onSuccess(data) {


            alert("exitoso");

        }
        function postComment() {



            var codEvento = @comm.codEvento;
            var usuario =$("#user_val").val();
            var contenido = $("#comm-cont-txt").val();



            if (contenido.length > 200){

                $("#warning_block").append("<Strong>Excede la cantidad de caracteres<Strong>").show();
                return;

            }else{
                var valor = $("#alerta").children('strong');
                if (valor.length > 0) {

                    valor.remove();

                }

                $("#alerta").hide();

            }


            if(contenido == ''){
                $("#warning_block").append("<Strong>Intento anadir un comentario vacio<Strong>").show();
                return;

            }else{

                var valor = $("#alerta").children('strong');
                if (valor.length > 0) {

                    valor.remove();

                }

                $("#alerta").hide();


            }




            cargarDatos('/Evento/EnviarComentario', codEvento, usuario, contenido);

            $("#comm-cont-txt").val("");
            $("#warning_block").hide();


        }


    function cargarDatos(linkUrl, codEvento, usuario, contenido ){



        var lista =  $(".block-comment");

        if(!isNaN(lista.length)){


            $.each(lista, function(k ,v){

                v.remove();


            });

            var link = $(".view-more");
            if(!isNaN(link.length))
                link.remove();


        }






        $.ajax({

            async: true,
            cache: false,
            type: 'POST',
            url: linkUrl ,
            dataType: 'json',
            data:  {codEvento : codEvento , usuario : usuario , contenido : contenido},
            success:  function(data){
                if(isNaN(data.length)) return;

                var cont = 0;
                $.each(data,function(k,v){



                    var fecha = Date(parseInt( v.fecha.substr(6))).toString();

                    if(cont>4){
                        $(".list-block-comment").append("<li onclick='agregarDatos()' align='center' value="+ cont +" class='list-group-item view-more'><a>Ver mas comentarios</a></li>");
                        $(".view-more").css({"cursor":"pointer"});

                        return;

                    }

                    $(".list-block-comment").append(" <li class='list-group-item block-comment'>"+
                        "<div class='block'>"+
                        "<div class='row comment-header'>"+
                        "<h4>"+ v.nombre + "</h4>"+
                        "</div>"+
                        "<div class='row comment-body'>"+
                        "<div class='col-md-1'>"+
                        "<img class='user-image img-thumbnail' src='/Images/Otros/usuario.png'></img>"+
                        "</div>"+
                        "<div class='col-md-6'>"+
                        "<div class='user-comment'><p>"+ v.contenido +"</p></div>"+
                        "</div>"+
                        "</div>"+
                        "<div align='right' class='comment-action row'>" +
                        "<span>"+ fecha +"<span>"+
                        "</div>"+
                        "</div>"+
                        "</li>"

                        );
                    cont++;

                });


            },
            error:function(){
                alert("....");


            }

        });






    }


    function agregarDatos(){


        var offset  = $(".view-more").val();
        var codEvento = @comm.codEvento;
        var usuario =$("#user_val").val();



        $.ajax({

            async: true,
            cache: false,
            type: 'POST',
            url: '/Evento/GetComents' ,
            dataType: 'json',
            data:  {codEvento : codEvento , usuario : usuario , offset: offset},
            success:  function(data){
                if(isNaN(data.length)) return;
                var cont = 0;
                var num = $(".view-more").val();
                $(".view-more").remove();
                $.each(data,function(k,v){



                    var fecha = Date(parseInt( v.fecha.substr(6))).toString();

                    if(cont>4){

                        num  =  num  + cont;
                        $(".list-block-comment").append("<li onclick='agregarDatos()' align='center' value="+ num +" class='list-group-item view-more'><a>Ver mas comentarios</a></li>");
                        $(".view-more").css({"cursor":"pointer"});

                        return;

                    }

                    $(".list-block-comment").append(" <li class='list-group-item block-comment'>"+
                        "<div class='block'>"+
                        "<div class='row comment-header'>"+
                        "<h4>"+ v.nombre + "</h4>"+
                        "</div>"+
                        "<div class='row comment-body'>"+
                        "<div class='col-md-1'>"+
                        "<img class='user-image img-thumbnail' src='/Images/Otros/usuario.png'></img>"+
                        "</div>"+
                        "<div class='col-md-6'>"+
                        "<div class='user-comment'><p>"+ v.contenido +"</p></div>"+
                        "</div>"+
                        "</div>"+
                        "<div align='right' class='comment-action row'>" +
                        "<span>"+ fecha +"<span>"+
                        "</div>"+
                        "</div>"+
                        "</li>"

                        );
                    cont++;

                });


            },
            error:function(){
                alert("....");


            }

        });







    }

    function RefreshWeb(ajaxData){

    var valor =  ajaxData;

    }


</script>

<style>


        .set-opts-btn{
        float: right;
        
        
        
    }



    .form-post {
        width: 100%;
    }

    div#comment-container textarea {
        height: 45px;
        line-height: 24px;
        min-height: 22px;
        overflow-y: hidden;
        padding-top: 1.1em;
    }

    #comm-cont-txt {
        width: 100%;
    }

    .wrapper-container {
        background-color: #f5f5f5;
    }

    .row-list {
        background: #286090;
    }

    .list-block-header {
        padding: 0 25px;
        color: white;
        background-color: #286090;
    }

    .block {
        padding: 0 20px;
    }
</style>